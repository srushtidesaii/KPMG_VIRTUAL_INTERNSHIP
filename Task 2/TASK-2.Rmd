---
title: "Untitled"
author: "Srushti Desai"
date: "1/13/2022"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Task 2: Data Insights
### Targeting high value customers based on customer demographics and attributes.


```{r}
library(dplyr)
library(lubridate)
library(readxl)
library(tidyverse)
```


```{r}
getwd()
```
```{r}
setwd("/Users/srushtidesai/Desktop")
```

```{r}
getwd()
```

```{r}
df2<-read_excel("KPMG_VI/KPMG_VI_New_raw_data_update_final.xlsx",sheet="NewCustomerList")
df3<-read_excel("KPMG_VI/KPMG_VI_New_raw_data_update_final.xlsx",sheet="CustomerDemographic")
```

### Data Exploration for New Customer List dataset

```{r}
#Dropping the unnamed columns from the datasets
df2 <- df2 %>% select(-...17,-...18,-...19,-...20,-...21)
```

```{r}
colnames(df2)
```

```{r}
#Convert the datatype of DOB column from numeric to date format 
df2$DOB<-as.Date(as.numeric(df2$DOB,na.rm=TRUE), origin = "1899-12-30")
```


```{r}
df2 %>% select(DOB)
```




```{r}
#Adding the calculated field like age and age_class with the help of the DOB column
df2 <- mutate(df2,age = as.numeric(difftime(Sys.Date(),df2$DOB, units = "weeks"))/52.25,age_class = round(age/10)*10 )
```

```{r}
colnames(df2)
```

```{r}
#Data Exploration: Age Distribution 
ggplot(data = df2, aes(x=age_class)) + geom_bar( fill="lightblue"  ) 
```


### Data Exploration for Customer Demographics dataset

#### Categories are not correctly named. So we have to rename the categories.

```{r}
#Rename the categories
df3 <- df3 %>% mutate(gender = recode(gender, Femal = "Female",
                                     Female = "Female",
                                      F = "Female",
                                      M = "Male",
                                    Male = "Male"))
```

```{r}
#to count number of occurrences grouped by gender
table(df3$gender)
```

```{r}
#Convert the datatype of DOB column from numeric to date format 
df3$DOB<-as.Date(as.numeric(df3$DOB,na.rm=TRUE), origin = "1899-12-30")
```

```{r}
df3 %>% select(DOB)
```
#### The values are inconsistent, hence dropping the default column

```{r}
#Dropping the default column from the datasets
df3 <- df3 %>% select(-default)

```



```{r}
colnames(df3)
```



```{r}
#Adding the calculated field like age and age_class with the help of the DOB column
df3 <- mutate(df3,age = as.numeric(difftime(Sys.Date(),df3$DOB, units = "weeks"))/52.25,age_class = round(age/10)*10 )
```

```{r}
colnames(df3)
```




```{r}
#Data Exploration: Age Distribution w.r.t. Bike Purchases
ggplot(df3, aes(x=age_class, y=past_3_years_bike_related_purchases, fill=age_class)) + 
geom_col(width = 2.5) 
```




```{r}
##Data Exploration: Gender Distribution w.r.t. Bike Purchases
ggplot(df3, aes(x=gender, y=past_3_years_bike_related_purchases, fill=gender)) + 
geom_col(width = 0.1)
```




```{r}
##Data Exploration: Job Industry Category w.r.t. Bike Purchases
ggplot(df3, aes(x=job_industry_category, y=past_3_years_bike_related_purchases, fill=job_industry_category)) + 
geom_col(width = 0.4) +theme(axis.text.x = element_text(angle = 45))
```


### RFM Analysis

```{r}
#Reading the each file separately
df1<-read_excel("KPMG_VI/KPMG_VI_New_raw_data_update_final.xlsx",sheet="Transactions")
```


```{r}
colnames(df1)
```






```{r}
#to count number of occurrences grouped by product_first_size_sold_date
table(df1$product_first_sold_date)

```



```{r}
#convert product_first_sold_date from numeric to date format
df1$product_first_sold_date<-as.Date(as.numeric(df1$product_first_sold_date,na.rm=TRUE), origin = "1899-12-30")
```


```{r}
#to count number of occurrences grouped by product_first_size_sold_date
table(df1$product_first_sold_date)

```


```{r}
#Adding the calculated field like profit
df1 <- mutate(df1,profit = df1$list_price - df1$standard_cost)
```


```{r}
colnames(df1)
```

```{r}
df1 %>% select(profit)
```


```{r}
head(df1)
```




```{r}
str(df1)
```


```{r}
max(df1$transaction_date)
```



```{r}
### Date of the Analysis: The date relative to which you want the recency to be calculated.
analysis_date <-max(df1$transaction_date)
```

```{r}
analysis_date
```



```{r}
install.packages("rfm", repos = "http://cran.us.r-project.org")
```


```{r}
#  “rfm” package requires that you have developer tools set up in your environment. 

install.packages("devtools", repos = "http://cran.us.r-project.org")
```



```{r}
library ("rfm")
```




```{r}
#Checking for null values for each column
colSums(is.na(df1))
```



```{r}
#Removing NA values from the dataset
df1 <- na.omit(df1)
```


```{r}
#Checking for null values for each column
colSums(is.na(df1))
```



```{r}
report <- rfm_table_order(df1, customer_id, transaction_date, profit,analysis_date)
```

```{r}
report 
```




```{r}
#Saving the report
write.csv (report$rfm,"rfm_report.csv", row.names = FALSE)
```



### Customer Segmentation


```{r}
#The data being used here is ideally broken down into the segments
segment_titles <- c("Champions", "Loyal Customers", "Potential Loyalist","New Customers", "Promising", "Need Attention", "About To Sleep", "At Risk", "Can’t Lose Them", "Hibernating", "Lost")

```
```{r}
#Numerical threshold for each component of RFM that categorizes customers in the segments.
r_low <- c(4, 2, 3, 4, 3, 2, 2, 1, 1, 1,1)
r_high <- c(5, 5, 5, 5, 4, 3, 3, 2, 1, 2,2)
f_low <- c(4, 3, 1, 1, 1, 2, 1, 2, 4,1, 1)
f_high <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2, 2)
m_low <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1, 1)
m_high <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2, 2)
```
```{r}
divisions<-rfm_segment(report, segment_titles, r_low, r_high, f_low, f_high, m_low, m_high)
```
```{r}
head(divisions,10)
```

```{r}
#to count number of occurrences grouped by segments
table(divisions$segment)
```


```{r}
pdf <- divisions %>% count(segment) %>% arrange(desc(n)) %>% rename(Segment = segment, Count = n)
```



```{r}
pdf 
```


```{r}
pdf <- pdf %>% mutate(percent =  Count/ sum(Count) * 100 ) 
```

```{r}
pdf
```



```{r}
 pdf$percent <- round(pdf$percent, digits=2)
```



```{r}
pdf
```

```{r}
write.csv(pdf,"piechart_viz.csv")
```



```{r}
# To create a treemap visualization
install.packages("treemapify", repos = "http://cran.us.r-project.org")
```



```{r}
library(treemapify)
```



```{r}
# Distribution of customer segments in percentages
pdf %>% ggplot(aes(area = percent, fill = Segment, label = percent , label = paste(Segment))) +
  geom_treemap() +
  geom_treemap_text(colour = "white",
                    place = "bottom",
                    size = 15)
```





```{r}
pdf %>% ggplot( aes(x = "", y = percent, fill = Segment)) +
  geom_col() +
  coord_polar(theta = "y")
```






```{r}
#Median Recency
rfm_plot_median_recency(divisions)
```

```{r}
#Median Frequency
rfm_plot_median_frequency(divisions)
```


```{r}
#Median Monetary Value
rfm_plot_median_monetary(divisions)
```




```{r}
# Heat Map
# Higher scores of frequency and recency are characterized by higher average monetary value as indicated by the darker areas in the heatmap.
rfm_heatmap(report)
```


```{r}
# Recency vs Monetary Value
# Higher revenue would be associated with most recent visits (that is low recency value which implies most recent visits.)
rfm_rm_plot(report)
```


```{r}
# Frequency vs Monetary Value
# As the frequency of visits increases, the revenue generated also increases. 
rfm_fm_plot(report)
```



```{r}
# Recency vs Frequency
# Higher frequency would be associated with the most recent visits. 
rfm_rf_plot(report)
```



```{r}
# Merging the transactions(df1) and divisions dataframes for data visualization 
d23 <- merge(x = divisions, y = df1, by = "customer_id", all = TRUE)
```


```{r}
head(d23,10)
```


```{r}
#Profit by each customer segments
dataviz1 <- d23 %>% select(segment,profit) %>% group_by(segment) %>% summarize(total_profit = sum(profit)) %>% arrange(desc(total_profit))
```


```{r}
dataviz1 
```

```{r}
write.csv(dataviz1,"dataviz1.csv")
```


```{r}
df33<-read_csv("CustomerDemographic_update_cleaned.csv")
```


```{r}
head(df33)
```

```{r}
#Removing NA values from the dataset
df33 <- na.omit(df33)
```

```{r}
head(df33)
```


```{r}
# Merging the transactions and divisions (that is d23) and customer demographic (df33) dataframes for data visualization 
d333 <- merge(x = df33, y = d23, by = "customer_id", all = TRUE)
```


```{r}

head(d333) 
```


```{r}
#Checking for null values for each column
colSums(is.na(d333))
```




```{r}
#Removing NA values from the dataset
d333 <- na.omit(d333)
```



```{r}
#Checking for null values for each column
colSums(is.na(d333))
```



```{r}
write.csv(d333,"3dataframes_merged_dataviz.csv")
```



```{r}
#Profit by each gender
dataviz2 <- d333 %>% select(gender,profit) %>% group_by(gender) %>% summarize(total_profit = sum(profit)) 
```




```{r}
dataviz2 
```

```{r}
write.csv(dataviz2,"dataviz2.csv")
```



```{r}
#Profit by wealth_segment
dataviz3 <- d333 %>% select(wealth_segment,profit) %>% group_by(wealth_segment) %>% summarize(total_profit = sum(profit)) 
```


```{r}

dataviz3 
```


```{r}
write.csv(dataviz3,"dataviz3.csv")
```







